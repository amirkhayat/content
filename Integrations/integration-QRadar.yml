commonfields:
  id: QRadar
  version: -1
name: QRadar
display: QRadar
category: SIEM & Analytics
image: data:image/png;base64,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
description: Get incidents and search QRadar
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    // The command input arg holds the command sent from the user.
    var username = params.credentials.identifier;
    var password = params.credentials.password;
    var server = params.server+'/';
    var insecure = params.insecure;

    var createIncidentFromOffense = function(incident) {
        var keys = Object.keys(incident);
        var labels = [];
        for (var i = 0; i<keys.length; i++) {
            labels.push({'type': keys[i], 'value': incident[keys[i]]});
        }
        return {
            "name": incident.id + ' ' + incident.description,
            "labels": labels,
        }
    }

    var sendRequest = function(method, url, headers, queryName) {
        var res = http(
                url,
                {
                    Headers: headers,
                    Method: method,
                    Username: username,
                    Password: password,
                },
                insecure
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to ' + queryName + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        console.log(typeof(JSON.parse(res.Body)))
        return JSON.parse(res.Body);
    }

    var getOffenses = function(filter, fields, range) {
        var urlArgs = {};
        if (filter) {
            urlArgs.filter = filter;
        }
        if (fields) {
            urlArgs.fields = fields;
        }
        var headers = {'Content-Type': ['application/json']};
        if (range) {
            headers.Range = ['items=' + range];
        }
        return sendRequest('GET', server + 'api/siem/offenses' + encodeToURLQuery(urlArgs), headers, 'siem offenses');
    }

    var search = function(query_expression, fields) {
        var urlArgs = {query_expression: query_expression};
        if (fields) {
            urlArgs.fields = fields;
        }
        return sendRequest('POST', server + 'api/ariel/searches' + encodeToURLQuery(urlArgs), {'Content-Type': ['application/json']}, 'searches');
    }

    var getSearch = function(search_id, fields) {
        var urlArgs = {};
        if (fields) {
            urlArgs.fields = fields;
        }
        return sendRequest('GET', server + 'api/ariel/searches/' + search_id + encodeToURLQuery(urlArgs), {'Content-Type': ['application/json']}, 'get search');
    }

    var getSearchResults = function(search_id, range) {
        var headers = {'Content-Type': ['application/json']};
        if (range) {
            headers.Range = ['items=' + range];
        }
        return sendRequest('GET', server + 'api/ariel/searches/' + search_id + '/results', headers, 'get search results');
    }

    switch (command) {
        case 'test-module':
            if (getOffenses()) {
                return 'ok';
            }
            return 'not ok';
        case 'fetch-incidents':
            var lastRun = getLastRun();
            var id = lastRun && lastRun.id ? lastRun.id : 0;
            var res = getOffenses('status=OPEN AND id>' + id);
            var incidents = [];
            for (var i = 0; i < res.length; i++) {
                var offense = res[i];
                id = Math.max(id, offense.id);
                incidents.push(createIncidentFromOffense(res[i]));
            }
            setLastRun({'id': id !== 0 ? id + 1 : 0});
            return JSON.stringify(incidents);
        case 'qr-offenses':
            return getOffenses(args.filter, args.fields, args.range);
        case 'qr-searches':
            return search(args.query_expression, args.fields);
        case 'qr-get-search':
            return getSearch(args.search_id, args.fields);
        case 'qr-get-search-results':
            return getSearchResults(args.search_id, args.range);
    }
  type: javascript
  commands:
  - name: qr-offenses
    arguments:
    - name: filter
      description: Query to filter offenses
    - name: fields
      description: 'Fields to filter in '
    - name: range
      description: Number of results in return
    description: Gets offenses from qradar
  - name: qr-searches
    arguments:
    - name: query_expression
      required: true
      default: true
      description: The query expressions in AQL
    - name: fields
      description: Fields to filter in
    description: Searches in QRadar
  - name: qr-get-search
    arguments:
    - name: search_id
      required: true
      default: true
      description: The search id
    - name: fields
      description: Fields to filter in
    description: Gets a specific search id
  - name: qr-get-search-results
    arguments:
    - name: search_id
      required: true
      default: true
      description: The search id
    - name: range
      description: Number of results in return
    description: Gets search results
  isfetch: true
  system: true
